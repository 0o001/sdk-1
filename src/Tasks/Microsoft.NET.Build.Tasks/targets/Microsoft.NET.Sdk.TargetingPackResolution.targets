<!--
***********************************************************************************************
Microsoft.NET.Sdk.TargetingPackResolution.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved. 
***********************************************************************************************
-->
<Project>
  <PropertyGroup>
    <ResolveAssemblyReferencesDependsOn>
      $(ResolveAssemblyReferencesDependsOn);
      ResolveTargetingPacks;
    </ResolveAssemblyReferencesDependsOn>
    <!-- TODO: How does conflict resolution fit in here?  Probably it should depend on ResolveTargetingPacks -->
  </PropertyGroup>

  <UsingTask TaskName="GetPackageDirectory" AssemblyFile="$(MicrosoftNETBuildTasksAssembly)" />
  
  <Target Name="ResolveTargetingPacks" DependsOnTargets="ResolvePackageAssets">

    <GetPackageDirectory
      Items="@(TargetingPack)"
      ProjectPath="$(MSBuildProjectFullPath)"
      PackageFolders="@(AssetFilePackageFolder)">

      <Output TaskParameter="Output" ItemName="ResolvedTargetingPack" />
      
    </GetPackageDirectory>    
    
    <ItemGroup>
      <ResolvedTargetingPack>
        <Path Condition="'%(ResolvedTargetingPack.Path)' == ''">%(PackageDirectory)</Path>
      </ResolvedTargetingPack>
      <Reference Include="%(ResolvedTargetingPack.Path)\ref\netcoreapp3.0\*.dll">
        <WinMDFile>false</WinMDFile>
        <Private>false</Private>
        <ReferenceGroupingDisplayName>.NET Core</ReferenceGroupingDisplayName>
        <ReferenceGrouping>%(ResolvedTargetingPack.Identity)</ReferenceGrouping>
        <ResolvedFrom>ResolveTargetingPacks</ResolvedFrom>
        <IsSystemReference>True</IsSystemReference>
      </Reference>
    </ItemGroup>
      
    <ItemGroup Condition="'$(RuntimeIdentifier)' == '' or '$(SelfContained)' != 'true'">
      <PackageConflictPlatformManifests Include="%(ResolvedTargetingPack.Path)\build\netcoreapp3.0\Microsoft.NETCore.App.PlatformManifest.txt"
                                        Condition="Exists('%(ResolvedTargetingPack.Path)\build\netcoreapp3.0\Microsoft.NETCore.App.PlatformManifest.txt')"/>
    </ItemGroup>

    <GetPackageDirectory
      Items="@(AppHostPack)"
      ProjectPath="$(MSBuildProjectFullPath)"
      PackageFolders="@(AssetFilePackageFolder)">

      <Output TaskParameter="Output" ItemName="ResolvedAppHostPack" />

    </GetPackageDirectory>

    <ItemGroup>
      <ResolvedAppHostPack>
        <Path Condition="'%(ResolvedAppHostPack.Path)' == ''">%(PackageDirectory)\%(RelativePath)</Path>
      </ResolvedAppHostPack>

      <AppHostTest Include="@(ResolvedAppHostPack)"/>
      
    </ItemGroup>

    <!--<Message Text="@(ResolvedAppHostPack)" />-->

    <PropertyGroup>
      <AppHostSourcePath>@(ResolvedAppHostPack->'%(Path)')</AppHostSourcePath>
    </PropertyGroup>


  </Target>
</Project>
