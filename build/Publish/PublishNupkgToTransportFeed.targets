<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) .NET Foundation and contributors. All rights reserved. Licensed under the MIT license. See License.txt in the project root for full license information. -->
<Project>

  <PropertyGroup>
    <OutputPathTransportFeed>$(ArtifactsConfigurationDir)</OutputPathTransportFeed>
    <MicrosoftDotNetBuildTasksFeedDll>$(NuGetPackageRoot)Microsoft.DotNet.Build.Tasks.Feed\$(MicrosoftDotNetBuildTasksFeedVersion)\lib\desktop\Microsoft.DotNet.Build.Tasks.Feed.dll</MicrosoftDotNetBuildTasksFeedDll>
  </PropertyGroup>

  <UsingTask TaskName="PushToBlobFeed" AssemblyFile="$(MicrosoftDotNetBuildTasksFeedDll)" />

  <ItemGroup>
    <NupkgsForPublishing Include="$(PackageOutputPath)Microsoft.NET.Sdk.*.nupkg" />
    <NupkgsForPublishing Include="$(PackageOutputPath)Microsoft.NET.Build.Extensions.*.nupkg" />
  </ItemGroup>

  <PropertyGroup>
    <RelativePath>packages</RelativePath>
    <TransportFeedContainerName>$(TRANSPORTFEED_STORAGE_CONTAINER)</TransportFeedContainerName>
    <TransportFeedContainerName Condition="'$(TransportFeedContainerName)' == ''">dotnet-core</TransportFeedContainerName>
    <TransportFeedCloudDropAccessToken>$(TRANSPORTFEED_STORAGE_KEY)</TransportFeedCloudDropAccessToken>
    <TransportFeedCloudDropAccountName>$(TRANSPORTFEED_STORAGE_ACCOUNT)</TransportFeedCloudDropAccountName>
    <TransportFeedCloudDropAccountName Condition="'$(TransportFeedCloudDropAccountName)' == ''">dotnetfeed</TransportFeedCloudDropAccountName>
  </PropertyGroup>

  <Target Name="PublishNupkgToTransportFeed"
          Condition=" '$(PUBLISH_NUPKG_TO_TRANSPORT_FEED)' == 'true' "
          DependsOnTargets="RestorePackageForTransportFeed;
                            PushNupkgToTransportFeed" />

  <Target Name="RestorePackageForTransportFeed">
    <PropertyGroup>
      <NewLineTF>
        <![CDATA[
]]>
      </NewLineTF>
      <SetNuget_PackagesTF>set NUGET_PACKAGES=$(NUGET_PACKAGES)</SetNuget_PackagesTF>
      <SetDotnet_Skip_FirstTime>set DOTNET_SKIP_FIRST_TIME_EXPERIENCE=true</SetDotnet_Skip_FirstTime>
      <PublishProjectFile>"$(MSBuildThisFileDirectory)Publish.csproj"</PublishProjectFile>
    </PropertyGroup>

    <Exec Command="$(SetNuget_PackagesTF)$(NewLineTF)$(SetDotnet_Skip_FirstTime)$(NewLineTF)$(DotNetTool) restore $(PublishProjectFile) /v:minimal"
          WorkingDirectory="$(RepositoryRootDirectory)" />
  </Target>

  <Target Name="PushNupkgToTransportFeed" >
    <Error Condition="'$(TransportFeedContainerName)' == ''" Text="Missing property TransportFeedContainerName." />
    <Error Condition="'$(TransportFeedCloudDropAccountName)' == ''" Text="Missing property TransportFeedCloudDropAccountName." />
    <Error Condition="'$(TransportFeedCloudDropAccessToken)' == ''" Text="Missing property TransportFeedCloudDropAccessToken." />

    <Message Text="Publish to $(TransportFeedContainerName) started" />
    <PushToBlobFeed AccountKey="$(TransportFeedCloudDropAccessToken)"
                AccountName="$(TransportFeedCloudDropAccountName)"
                ContainerName="$(TransportFeedContainerName)"
                IndexDirectory="$(IndexDirectory)"
                ItemsToPush="@(NupkgsForPublishing)"
                Overwrite="false"
                PublishFlatContainer="false"
                RelativePath="$(RelativePath)" />
  </Target>

</Project>
